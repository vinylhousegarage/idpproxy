name: CI

on:
  pull_request:
    branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    env:
      FIRESTORE_EMULATOR_HOST: 127.0.0.1:9010
      GOOGLE_APPLICATION_CREDENTIALS_BASE64: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_BASE64 }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      GOOGLE_CLOUD_PROJECT: demo-idpproxy
      GOOGLE_REDIRECT_URI: ${{ secrets.GOOGLE_REDIRECT_URI }}
      OPENAPI_URL: ${{ secrets.OPENAPI_URL }}
      TEST_FIRESTORE_PROJECT: demo-idpproxy

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.5'
          cache: true

      - name: Ensure netcat
        run: sudo apt-get update && sudo apt-get install -y netcat-openbsd

      - name: Start Firestore emulator (cloud-sdk)
        run: |
          docker run -d --name fs-emu -p 9010:8080 gcr.io/google.com/cloudsdktool/cloud-sdk:latest \
            bash -lc "apt-get update && apt-get install -y openjdk-17-jre-headless && \
                      gcloud components install cloud-firestore-emulator -q && \
                      gcloud beta emulators firestore start --host-port=0.0.0.0:8080 --quiet"

      - name: Wait for Firestore emulator
        run: |
          for i in {1..180}; do
            if nc -z 127.0.0.1 9010 && curl -fsS http://127.0.0.1:9010 >/dev/null 2>&1; then
              sleep 2
              exit 0
            fi
            sleep 1
          done
          echo "Emulator not responding on 127.0.0.1:9010" >&2
          docker logs fs-emu || true
          docker ps -a || true
          docker port fs-emu || true
          exit 1

      - name: Download modules
        run: go mod download

      - name: Run goimports (lint for imports)
        run: |
          go install golang.org/x/tools/cmd/goimports@v0.35.0
          imports="$(goimports -l .)"
          if [ -n "$imports" ]; then
            echo "$imports"
            exit 1
          fi

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v5
        with:
          version: v1.64.8
          args: --timeout 5m --out-format=colored-line-number

      - name: Run tests
        run: go test ./... -v -count=1

      - name: Dump emulator logs (on-failure)
        if: failure()
        run: docker logs fs-emu || true
